<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>いしかわモノノケMAP</title>
    <!-- Google Font for futuristic vibe -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Center ripple on main page */
        #center-ripple-container {
            position: fixed;
            top: 50%;
            left: 50%;
            width: 300px;
            height: 300px;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 1;
            transition: opacity 0.5s ease-in-out;
        }
        #center-ripple-container .ripple {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 300px;
            height: 300px;
            border: 4px solid rgba(255,26,26,0.5);
            border-radius: 50%;
            opacity: 0;
            transform: translate(-50%, -50%) scale(0);
            animation: centerRing 4s infinite;
        }
        #center-ripple-container .ripple:nth-child(2) { animation-delay: 1.33s; }
        #center-ripple-container .ripple:nth-child(3) { animation-delay: 2.66s; }
        @keyframes centerRing {
            0% { opacity: 0.6; transform: translate(-50%, -50%) scale(0); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1.5); }
        }

        body {
            margin: 0;
            padding: 0;
            background-color: #0d0d0d;
            color: #fff;
            font-family: 'Orbitron', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            min-height: 100vh;
        }
        .main-page {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            width: 100%;
            position: fixed;
            top: 0;
            left: 0;
            transition: opacity 0.5s ease-in-out;
            z-index: 2;
        }
        .main-page.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .app-container {
            display: none; /* Initially hidden */
            flex-direction: column;
            align-items: center;
            width: 100%;
            position: relative;
            z-index: 2;
            transition: opacity 0.5s ease-in-out;
            opacity: 0;
            padding-bottom: 80px; /* Space for the floating button */
        }
        .app-container.visible {
            display: flex;
            opacity: 1;
        }

        h1, h2 {
            position: relative;
            z-index: 2;
        }
        h1 {
            margin-top: 20px;
            color: #ff4d4d;
            text-shadow: 0 0 10px #ff4d4d;
            font-size: 2rem;
            text-align: center;
        }
        h2 {
            margin: 5px 0 20px;
            font-weight: 400;
            color: #ccc;
            text-shadow: 0 0 5px #fff;
            font-size: 1rem;
            text-align: center;
        }
        #searchBtn {
            padding: 12px 24px;
            font-size: 1rem;
            background-color: #ff1a1a;
            color: #fff;
            border: 2px solid #ff1a1a;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }
        #searchBtn:hover:not(:disabled) {
            background-color: transparent;
            color: #ff1a1a;
        }
        #searchBtn:disabled {
            background-color: #550000;
            border-color: #550000;
            cursor: not-allowed;
        }
        /* Loading Overlay */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            flex-direction: column;
            color: #ff4d4d;
        }
        .overlay .ripple-container {
            position: relative;
            width: 200px;
            height: 200px;
            margin-bottom: 20px;
        }
        .overlay .ripple {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 200px;
            height: 200px;
            border: 4px solid #ff1a1a;
            border-radius: 50%;
            opacity: 0;
            transform: translate(-50%, -50%) scale(0);
            animation: ripple 1s infinite;
        }
        @keyframes ripple {
            0% { opacity: 1; transform: translate(-50%, -50%) scale(0); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1.2); }
        }
        #map {
            width: 90%;
            max-width: 800px;
            height: 500px;
            border: 2px solid #ff4d4d;
            border-radius: 8px;
            box-shadow: 0 0 15px #ff4d4d;
            margin-bottom: 20px;
            z-index: 2;
        }
        #results-container {
            width: 90%;
            max-width: 800px;
            margin-bottom: 40px;
            overflow-x: auto;
            z-index: 2;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-family: 'Orbitron', sans-serif;
            margin-top: 1rem;
        }
        th, td {
            padding: 8px 12px;
            border: 1px solid #555;
            text-align: center;
        }
        th {
            background-color: #222;
            color: #ff4d4d;
            text-shadow: 0 0 5px #ff4d4d;
        }
        td {
            background-color: #1a1a1a;
            color: #ccc;
        }
        .map-icon-container {
            position: relative;
            width: 32px;
            height: 32px;
        }
        .map-icon-container img {
            width: 100%;
            height: 100%;
        }
        .map-ripple-container {
            position: relative;
            width: 100px;
            height: 100px;
        }
        .map-ripple-container .ripple {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            opacity: 0;
            transform: translate(-50%, -50%) scale(0);
        }
        .map-ripple-container .ripple.bear-ripple {
            border: 3px solid #ff1a1a;
            animation: mapRippleRed 3s infinite;
        }
        .map-ripple-container .ripple.mononoke-ripple {
            border: 3px solid #4dff4d;
            animation: mapRippleGreen 3s infinite;
        }
        .map-ripple-container .ripple:nth-child(2) { animation-delay: 1s; }
        .map-ripple-container .ripple:nth-child(3) { animation-delay: 2s; }
        @keyframes mapRippleRed {
            0% { opacity: 0.6; transform: translate(-50%, -50%) scale(0); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1.5); }
        }
        @keyframes mapRippleGreen {
            0% { opacity: 0.6; transform: transform: translate(-50%, -50%) scale(0); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1.5); }
        }

        /* Tab styles */
        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 10px;
        }
        .tab-button {
            background: transparent;
            border: 1px solid #555;
            color: #ccc;
            padding: 8px 16px;
            margin: 0 4px;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        .tab-button.active {
            background-color: #ff1a1a;
            border-color: #ff1a1a;
            color: #fff;
            box-shadow: 0 0 10px #ff1a1a;
        }
        .tab-button:hover:not(.active) {
            background-color: #333;
            color: #ff4d4d;
            border-color: #ff4d4d;
        }

        /* Post button */
        #post-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px;
            background-color: #4dff4d; /* Mononoke-themed color */
            color: #0d0d0d;
            border: 2px solid #4dff4d;
            border-radius: 50%;
            box-shadow: 0 0 15px #4dff4d;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        #post-button:hover {
            background-color: transparent;
            color: #4dff4d;
        }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none; /* Initially hidden */
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: #1a1a1a;
            border: 2px solid #ff4d4d;
            border-radius: 8px;
            box-shadow: 0 0 15px #ff4d4d;
            padding: 20px;
            width: 90%;
            max-width: 500px;
            color: #ccc;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #555;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .modal-header h3 {
            font-size: 1.5rem;
            color: #ff4d4d;
            text-shadow: 0 0 5px #ff4d4d;
        }
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #ff4d4d;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        .modal-close:hover {
            color: #fff;
        }
        .modal-form label {
            display: block;
            margin-bottom: 5px;
            color: #ff4d4d;
            text-shadow: 0 0 3px #ff4d4d;
        }
        .modal-form input, .modal-form select, .modal-form textarea {
            width: 100%;
            padding: 8px;
            margin-bottom: 15px;
            background-color: #333;
            border: 1px solid #555;
            border-radius: 4px;
            color: #fff;
            font-family: 'Orbitron', sans-serif;
        }
        .modal-form textarea {
            min-height: 80px;
        }
        .modal-form button {
            background-color: #ff1a1a;
            color: #fff;
            padding: 10px 20px;
            border: 2px solid #ff1a1a;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Orbitron', sans-serif;
        }
        .modal-form button:hover {
            background-color: transparent;
            color: #ff1a1a;
        }
    </style>
</head>
<body>
    <!-- Main Landing Page -->
    <div id="main-page" class="main-page">
        <!-- Center ripple effect -->
        <div id="center-ripple-container">
            <div class="ripple"></div>
            <div class="ripple"></div>
            <div class="ripple"></div>
        </div>
        <h1>いしかわモノノケMAP</h1>
        <h2>あなたの現在地から、現実と空想のモノノケをスキャンします。</h2>
        <button id="searchBtn">近くのモノノケを探す</button>
    </div>

    <!-- App UI (initially hidden) -->
    <div id="app-container" class="app-container">
        <h1>いしかわモノノケMAP</h1>
        <h2 id="subtitle"></h2>
        
        <div id="map"></div>
        <div id="results-container">
            <div class="tabs">
                <button class="tab-button active" data-tab="all">すべて</button>
                <button class="tab-button" data-tab="reality">現実 (クマ)</button>
                <button class="tab-button" data-tab="fantasy">空想 (モノノケ)</button>
            </div>
            <div id="table-container"></div>
        </div>
        
        <!-- 投稿ボタン (フローティング) -->
        <button id="post-button">
            <i class="fa-solid fa-plus fa-lg"></i>
        </button>
    </div>
    
    <!-- Loading Overlay -->
    <div id="overlay" class="overlay">
        <div class="ripple-container">
            <div class="ripple"></div>
            <div class="ripple"></div>
            <div class="ripple"></div>
        </div>
        <div>スキャン中...</div>
    </div>

    <!-- 投稿モーダル -->
    <div id="post-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>情報を投稿する</h3>
                <button class="modal-close" id="close-modal">&times;</button>
            </div>
            <form id="post-form" class="modal-form">
                <label for="post-type">種類</label>
                <select id="post-type">
                    <option value="bear">ツキノワグマ</option>
                    <option value="mononoke">モノノケ</option>
                    <option value="deer">鹿</option>
                    <option value="boar">猪</option>
                    <option value="monkey">猿</option>
                </select>
                <label for="post-location">発見場所</label>
                <input type="text" id="post-location" placeholder="例: 〇〇山" />
                <label for="post-comment">コメント</label>
                <textarea id="post-comment" placeholder="状況や詳細を記入"></textarea>
                <button type="submit">投稿</button>
            </form>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Global variables
        let map;
        let userLocation = null;
        let allData = [];

        // CSVデータのファイルパス
        const csvFilePath = './files/bear_ishikawa_r1_r6.csv';
        
        // Leaflet.DivIconを使ってSVG画像をアイコンとして表示
        const bearIcon = L.icon({
            iconUrl: './files/bear.svg',
            iconSize: [32, 32],
            iconAnchor: [16, 32], 
            popupAnchor: [0, -32] 
        });
        
        const mononokeIcon = L.icon({
            iconUrl: './files/mononoke.svg',
            iconSize: [32, 32],
            iconAnchor: [16, 32],
            popupAnchor: [0, -32]
        });

        const userIcon = L.icon({
            iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34]
        });

        // 2点間の距離を計算する関数 (Haversineの公式)
        function haversine(lat1, lon1, lat2, lon2) {
            const toRad = deg => deg * Math.PI / 180;
            const R = 6371; // Earth's radius in km
            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);
            const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // Distance in km
        }

        // マップを初期化する関数
        function initMap(lat, lng) {
            if (map) {
                map.remove(); // 既存のマップを削除
            }
            map = L.map('map').setView([lat, lng], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
        }
        
        // 表を構築する関数
        function buildTable(data) {
            const tableContainer = document.getElementById('table-container');
            if (!data.length) {
                tableContainer.innerHTML = '<p style="text-align: center; color: #ff4d4d; font-size: 1rem;">データが見つかりませんでした。</p>';
                return;
            }
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>種類</th>
                            <th>名前/場所</th>
                            <th>詳細</th>
                            <th>距離 (km)</th>
                            <th>日時</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            data.forEach(item => {
                html += `
                    <tr>
                        <td>${item.type}</td>
                        <td>${item.name}</td>
                        <td>${item.notes}</td>
                        <td>${item.distance.toFixed(2)}</td>
                        <td>${item.timestamp ? new Date(item.timestamp).toLocaleString('ja-JP') : '-'}</td>
                    </tr>
                `;
            });
            html += '</tbody></table>';
            tableContainer.innerHTML = html;
        }

        // マーカーをマップに追加する関数
        function addMarkers(data) {
            // マーカーをクリアする
            if (map) {
                map.eachLayer(layer => {
                    if (layer instanceof L.Marker) {
                        map.removeLayer(layer);
                    }
                });
            }

            // 現在地マーカーを再描画
            L.marker([userLocation.lat, userLocation.lng], { icon: userIcon }).addTo(map).bindPopup('現在地', { offset: L.point(1, -25) }).openPopup();

            data.forEach(item => {
                const isBear = item.type === '現実';
                const icon = isBear ? bearIcon : mononokeIcon;
                const marker = L.marker([item.lat, item.lng], { icon: icon }).addTo(map)
                    .bindPopup(`<strong>${item.name}</strong><br/>${item.notes}`);

                if (isBear) {
                    const rippleContainer = document.createElement('div');
                    rippleContainer.className = 'map-ripple-container';
                    const rippleClass = 'bear-ripple';
                    rippleContainer.innerHTML = `
                        <div class="ripple ${rippleClass}"></div>
                        <div class="ripple ${rippleClass}"></div>
                        <div class="ripple ${rippleClass}"></div>
                    `;
                    const rippleIcon = L.divIcon({ html: rippleContainer.outerHTML, className: '', iconSize: [100, 100], iconAnchor: [50, 50] });
                    L.marker([item.lat, item.lng], { icon: rippleIcon, interactive: false }).addTo(map);
                }
            });
        }
        
        // CSVデータをパースして処理する関数
        function parseCsvData(csvText, userLat, userLng) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split('\t').map(h => h.replace(/\r/g, ''));
            const data = lines.slice(1).map(line => {
                const values = line.split('\t').map(v => v.replace(/\r/g, ''));
                let row = {};
                headers.forEach((header, i) => {
                    row[header] = values[i];
                });

                const lat = parseFloat(row['緯度']);
                const lng = parseFloat(row['経度']);

                const dateString = `20${row['出没年'].substring(1)}/${row['出没日'].substring(2).replace(/\./g, '/')} ${row['時刻']}`;
                const timestamp = new Date(dateString).getTime();

                const distance = haversine(userLat, userLng, lat, lng);

                return {
                    id: row['ID'],
                    type: '現実',
                    name: `クマ(${row['頭数']}頭)`,
                    lat: lat,
                    lng: lng,
                    timestamp: timestamp,
                    notes: `${row['市町名']} ${row['場所']} - ${row['備考']}`,
                    distance: distance
                };
            }).filter(item => item !== null);
            return data;
        }

        // ダミーのモノノケデータ（CSVデータに合わせて形式を調整）
        function getDummyMononokeData(userLat, userLng) {
            const mononokeData = [
                { name: 'カッパ', lat: userLat + 0.02, lng: userLng + 0.01, notes: '浅野川に伝わる伝説の生物' },
                { name: '天狗', lat: userLat - 0.03, lng: userLng + 0.04, notes: '大乗寺山に住むと言われる山神' },
                { name: '化け狐', lat: userLat + 0.05, lng: userLng - 0.02, notes: '卯辰山に現れると言われる' },
            ];
            
            return mononokeData.map((m, index) => {
                const distance = haversine(userLat, userLng, m.lat, m.lng);
                return {
                    id: `m${index}`,
                    type: '空想',
                    name: m.name,
                    lat: m.lat,
                    lng: m.lng,
                    timestamp: null,
                    notes: m.notes,
                    distance: distance
                };
            });
        }

        // メイン処理：位置情報を取得し、データを表示
        function processLocation(lat, lng, isFallback = false) {
            userLocation = { lat, lng };

            fetch(csvFilePath)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.text();
                })
                .then(csvText => {
                    // ここでCSVの区切り文字をタブに修正
                    const bearData = parseCsvData(csvText, lat, lng);
                    const mononokeData = getDummyMononokeData(lat, lng);

                    const filteredBears = bearData.filter(b => b.distance <= 1);
                    const filteredMononoke = mononokeData.filter(m => m.distance <= 5);

                    allData = [...filteredBears, ...filteredMononoke];

                    if (isFallback) {
                        document.getElementById('subtitle').innerText = `現在地が取得できませんでした。金沢市役所付近のデータで表示します。`;
                    } else {
                        document.getElementById('subtitle').innerText = `あなたの現在地から、現実と空想のモノノケをスキャンしました。`;
                    }

                    initMap(userLocation.lat, userLocation.lng);
                    L.marker([userLocation.lat, userLocation.lng], { icon: userIcon }).addTo(map).bindPopup('現在地', { offset: L.point(1, -25) }).openPopup();
                    addMarkers(allData);
                    buildTable(allData);

                    overlay.style.display = 'none';
                    appContainer.classList.add('visible');
                    map.invalidateSize();
                })
                .catch(error => {
                    console.error('Failed to load CSV data:', error);
                    alert('データの読み込みに失敗しました。');
                    
                    // エラー発生時もUIは表示する
                    const fallbackLat = 36.561334;
                    const fallbackLng = 136.656209;
                    userLocation = { lat: fallbackLat, lng: fallbackLng };

                    document.getElementById('subtitle').innerText = `データの読み込みに失敗しました。金沢市役所付近のダミーデータで表示します。`;
                    
                    const dummyMononokeData = getDummyMononokeData(fallbackLat, fallbackLng);
                    allData = [...dummyMononokeData];

                    initMap(userLocation.lat, userLocation.lng);
                    L.marker([userLocation.lat, userLocation.lng], { icon: userIcon }).addTo(map).bindPopup('現在地', { offset: L.point(1, -25) }).openPopup();
                    addMarkers(allData);
                    buildTable(allData);

                    overlay.style.display = 'none';
                    appContainer.classList.add('visible');
                    map.invalidateSize();
                });
        }

        // イベントリスナー
        document.addEventListener('DOMContentLoaded', () => {
            const searchBtn = document.getElementById('searchBtn');
            const mainPage = document.getElementById('main-page');
            const appContainer = document.getElementById('app-container');
            const overlay = document.getElementById('overlay');
            const postBtn = document.getElementById('post-button');
            const postModal = document.getElementById('post-modal');
            const closeModalBtn = document.getElementById('close-modal');
            const postForm = document.getElementById('post-form');
            const tabsContainer = document.querySelector('.tabs');
            
            searchBtn.addEventListener('click', () => {
                searchBtn.disabled = true;
                mainPage.classList.add('hidden');
                overlay.style.display = 'flex';
                
                const geoOptions = {
                    enableHighAccuracy: true,
                    timeout: 10000, 
                    maximumAge: 0
                };
                
                if ("geolocation" in navigator) {
                    navigator.geolocation.getCurrentPosition(
                        (pos) => {
                            setTimeout(() => {
                                processLocation(pos.coords.latitude, pos.coords.longitude);
                            }, 3000);
                        },
                        (error) => {
                            console.error("Geolocation error:", error);
                            const fallbackLat = 36.561334;
                            const fallbackLng = 136.656209;
                            setTimeout(() => {
                                alert('位置情報の取得に失敗しました。金沢市役所付近のデータで表示します。');
                                processLocation(fallbackLat, fallbackLng, true);
                            }, 3000);
                        },
                        geoOptions
                    );
                } else {
                    const fallbackLat = 36.561334;
                    const fallbackLng = 136.656209;
                    setTimeout(() => {
                        alert('お使いのブラウザは位置情報に対応していません。金沢市役所付近のデータで表示します。');
                        processLocation(fallbackLat, fallbackLng, true);
                    }, 3000);
                }
            });
            
            tabsContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('tab-button')) {
                    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    
                    const tab = e.target.getAttribute('data-tab');
                    let filteredData = [];
                    if (tab === 'all') {
                        filteredData = allData;
                    } else if (tab === 'reality') {
                        filteredData = allData.filter(item => item.type === '現実');
                        filteredData.sort((a, b) => b.timestamp - a.timestamp); // 日付の新しい順
                    } else if (tab === 'fantasy') {
                        filteredData = allData.filter(item => item.type === '空想');
                        filteredData.sort((a, b) => a.distance - b.distance); // 距離の近い順
                    }
                    buildTable(filteredData);
                }
            });

            // Modal events
            postBtn.addEventListener('click', () => postModal.style.display = 'flex');
            closeModalBtn.addEventListener('click', () => postModal.style.display = 'none');
            postModal.addEventListener('click', (e) => {
                if (e.target === postModal) postModal.style.display = 'none';
            });
            postForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const type = document.getElementById('post-type').value;
                const location = document.getElementById('post-location').value;
                const comment = document.getElementById('post-comment').value;

                console.log('投稿データ:', { type, location, comment, timestamp: new Date().toISOString() });
                alert('投稿が完了しました！');
                postModal.style.display = 'none';
                postForm.reset();
            });
        });
    </script>
</body>
</html>
